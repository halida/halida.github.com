
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>网络寻租</title>
  <meta name="author" content="机械唯物主义">

  
  <meta name="description" content="昨天, 某个朋友给我推荐了一本书: 书名是
悠游度过一天的24小时. 这本书不错. 如果你觉得自己每天虚度光阴, 可以看这本书,
这本书提供了一些改变的方法, 简单易行. 上周在 primesplus 里面和他们聊天,
提到一个问题: 中国的程序员大多没有生活. 每天上班下班两点一线, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.linjunhalida.com/blog/page/26/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="网络寻租" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> -->
<!-- <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> -->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26509244-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">网络寻租</a></h1>
  
    <h2>Programmer, Gamer, Hacker</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.linjunhalida.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">博客</a></li>
  <li><a href="/blog/categories/english">English Blog</a></li>
  <li><a href="/about">关于我</a></li>
  <li><a href="/blog/archives">存档</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-to-organize-day-time/">如何度过每天的24小时</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-22T11:16:08+08:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2011</time>
        
         | <a href="/blog/how-to-organize-day-time/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>昨天, 某个朋友给我推荐了一本书: 书名是
<a href="http://book.douban.com/subject/4243207/">悠游度过一天的24小时</a>.</p>

<p>这本书不错. 如果你觉得自己每天虚度光阴, 可以看这本书,
这本书提供了一些改变的方法, 简单易行.</p>

<p>上周在 <a href="http://www.primesplus.com/">primesplus</a> 里面和他们聊天,
提到一个问题: 中国的程序员大多没有生活. 每天上班下班两点一线,
晚上在住的地方宅起, 要么就是一直都钻在技术里面, 长此以往, 人会憋坏的.
如果你觉得自己就是这样的人, 可以读读这本书.</p>

<p>下面是我整理出来的一些要点, 如果你不想被剧透, 那么就不要往下看了,
直接去买本来看吧.</p>

<ul>
<li>我们每个人都拥有同样的时间: 每天24小时</li>
<li>但是我们一般来说, 都很难利用好这些时间.</li>
<li>开始前提醒: 这个过程很艰难, 不要期望过高, 要有心理准备,
不要被失败压垮了.</li>
<li>一个示例: 人们往往没有利用好每天的时间, 在时间处理上态度不对,
工作的时候有抵触情绪, 下班后宝贵的自由时间以休息的理由,
随意消耗掉了.</li>
<li>除去上班8小时, 休息8小时, 损耗2小时, 人还有大约6小时的自由时间,
好好利用.</li>
<li>上下班的时间不要消磨掉, 利用好这段时间.</li>
<li>上班途中的时间用来锻炼心智, 约束自己的大脑想特定的事情.</li>
<li>下班途中的时间用来反省.</li>
<li>下班后承认自己并不累, 好好计划下班后的时间, 过真正充实的生活.</li>
<li>幸福并非源于肉体或精神上的享乐, 而在于充实自己的理性思考,
并采取符合自己原则的行为方式.</li>
<li>诗歌可能是最高形式的文艺形式, 给人以最大的愉悦并予人以最深邃的智慧.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/git/">Git学习总结</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-07T14:43:14+08:00" pubdate data-updated="true">Jan 7<span>th</span>, 2011</time>
        
         | <a href="/blog/git/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://lh5.ggpht.com/_UL5xJ4XsSh8/TO5reHrOWVI/AAAAAAAAAy8/6IufPsBgZQE/GIT-cheatsheet.jpg?imgmax=800" alt="image" /></p>

<p>虽然我的主力版本控制系统是hg, 但是既然在开源社区里面混, git是绕不掉的.
平时接触到git的项目, 为了能够正常使用不出篓子, 还是要系统地学习一下git.
这里推荐 <a href="http://git-scm.com/">git官方教程</a>. 基础如何使用就不多说了,
网上漫天都是, 这里面整理一下使用CVS的一些经验, 绝大多数是从
<a href="http://www.jeffkit.info/2010/12/885/">其他人</a> 那里抄过来的.
抄是学习的一大利器, 只要会抄, 什么事情都好办,
全世界那么多顶级的开源项目, 抄会一个, 吃穿不愁了&mdash;-有点离题了.</p>

<p>首先, CVS不是备份工具, 如果你一股脑地把所有修改过的文件commit上去,
那么还不如去用 <a href="http://www.dropbox.com/">dropbox</a>.
我们要让版本库里面呈现的东西, 恰如其分地反应出开发流程, 方便流程控制,
阅读和处理. 那么CVS的使用, 应该符合专业的软件开发流程:</p>

<ul>
<li>每次提交代码, 应该是完成一项特定的工作, 提交的内容,
提交者应该能够回溯跟踪.</li>
<li>代码分为开发版本, 以及发布版本.</li>
<li>对于重要的阶段, 需要记录下来, 比如不同的发布版本号对应阶段的代码.</li>
</ul>


<p>那么我们在使用的时候应该如何做呢? 根据
<a href="http://www.kernel.org/pub/software/scm/git/docs/gitworkflows.html">gitworkflows</a>:</p>

<p>拆分变更</p>

<blockquote><p>每次我们修改代码, 可能同时根据无数的需求改了非常多的地方,
我们在提交的时候, 需要尽量按照逻辑拆分出来, 分别commit它们.
这样出来的历史才有足够的可读性. 没有可读性我们还记录它们干什么?</p></blockquote>

<p>分支管理</p>

<blockquote><p>我们需要有至少2个分支: 开发分支和发布分支, 平时在开发分支干活,
需要发布的时候, 提交到发布分支上面去, 并且根据版本加tag. 注意,
提交到发布分支上面的代码是通过流程保证稳定性的.</p></blockquote>

<p>关于上面的流程管控, 有个神器可以使用: <a href="http://www.jeffkit.info/2010/12/842/">git
flow</a>,
这里面的教程看一遍就能够体会到威力了.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/shiboken/">用shiboken做python绑定</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-07T11:23:31+08:00" pubdate data-updated="true">Jan 7<span>th</span>, 2011</time>
        
         | <a href="/blog/shiboken/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://www.pyside.org/docs/shiboken-0.5.0/_images/generatorworkings.png" alt="image" /></p>

<p>pyside的项目已经beta了一段时间了,
它采用的方法是开发一个名为shiboken的绑定生成工具来做处理.
我们也可以利用这个工具来简化做python绑定的工作.</p>

<h2>具体工作流程</h2>

<p>上面的图代表了整个体系工作的方法. 用户提供2个信息: 需要绑定的库的头文件,
以及建立一个需要绑定的库的描述信息文件(xml),
以及在这个描述文件里面手动对生成内容做一些修改. 如果一切顺利的话,
只需要在描述文件里面说明需要绑定到python里面的类/枚举等信息即可.</p>

<h2>如何用?</h2>

<p>具体可以见
<a href="http://developer.qt.nokia.com/wiki/PySide_Binding_Generation_Tutorial">shiboken官方教程</a>,
走到这一步的同学应该对英文没有压力的吧, 我就不再整理成中文了,
毕竟作者他们也都不是英语母语的.</p>

<p>一般情况下, 我们只需要直接下载里面附带的示例, 然后修改一番,
就可以用来给我们自己的库来做绑定了. 我现在就是这样做的.</p>

<h2>如何实现的?</h2>

<p>上面都是具体的做法, 在实际的使用过程中还会遇到各种各样的问题,
我们可能还需要对shiboken机制有一定的了解.</p>

<h2>编译过程</h2>

<p>我们写了xml描述文件之后, 实际执行的命令是generatorrunner,
它会按照xml文件, 以及引入的库头文件, 生成wrapper的cpp/h文件. 之后,
我们把这些文件编译成动态链接库, 这个链接库能够直接被python调用. 如下图:</p>

<pre><code>global.h             generatorrunner                       gcc
typesystem_foo.xml -------------------&gt; wrapper.h/cpp ---------&gt; libfoo.so
</code></pre>

<h2>generatorrunner运作机制</h2>

<p>这里是
<a href="http://www.pyside.org/docs/generatorrunner/overview.html">generator运作机制</a>
的介绍.</p>

<p><img src="http://www.pyside.org/docs/generatorrunner/_images/bindinggen-development.png" alt="image" />
如上图, 分成几个模块, api extractor获取头文件的信息,
typesystem和injected code就是那个xml描述文件.
shiboken就是generatorrunner后台调用的cpp文件生成工具了.</p>

<h2>结论</h2>

<p>具体shiboken是如何处理的, 以及为了调试方便, 如何获取中间生成的类信息,
这个我还需要时间去了解. 他们的作者也是很开放的, 如果发现问题, 可以往:
<a href="mailto:pyside@lists.openbossa.org">pyside@lists.openbossa.org</a>
邮件列表上面发邮件提问,
作者基本上是会给回应的(毕竟他们是nokia雇来做这个事情的).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/pysideqwt-open-source/">Pysideqwt开源经验</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-06T12:40:35+08:00" pubdate data-updated="true">Jan 6<span>th</span>, 2011</time>
        
         | <a href="/blog/pysideqwt-open-source/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>我现在的项目采用pyqt开发, 利用到了pyqwt, 但是pyqt闭源的话是要授权费用的.
nokia他们因此弄出了lgpl的pyside. 我现在一直在跟进.
不过缺少qwt对pyside的绑定, 我的项目跑不起来.</p>

<p>与其等待有人来做这件事, 不如我自己弄吧. 于是我自己就建了一个:
<a href="http://gitorious.org/pysideqwt#more">http://gitorious.org/pysideqwt#more</a>
本来预期很难的, 不过实际做起来还是比较顺利的, 现在还在开发中. 期间,
遇到了不少问题, 也得到了pyside开发小组的帮助.
甚至还提交了我一生中第一个patch.</p>

<p>项目本身不说明什么, 我只想说一下这个过程是怎么思考的,
感觉这个才是开源的本质:</p>

<p>我们在项目开发中, 往往会发现某些问题非常通用,
值得很多企业外部的人一起来解决,
或者自己的解决方案可以被很多外部人士用到. 这样的话, 选择开源,
对自己的商业模式没有影响, 反而可以造福他人, 也可以给自己带来无形的收益.
我想, 这才是开源生存的重要支柱.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/use-plain-text-for-documentation/">使用纯文本方式写文档</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-26T09:31:10+08:00" pubdate data-updated="true">Dec 26<span>th</span>, 2010</time>
        
         | <a href="/blog/use-plain-text-for-documentation/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>大家用什么方式写文档?</h2>

<h2>为什么要用纯文本</h2>

<h2>WYSIWYG</h2>

<h2>自由</h2>

<h2>专注</h2>

<h2>word</h2>

<p><img src="http://www.viemu.com/ViEmu-Word-2007.gif" alt="image" /></p>

<h2>xml</h2>

<p><img src="http://www.kirupa.com/net/images/xml_doc2.gif" alt="image" /></p>

<h2>应该是这样的</h2>

<pre><code>Book:
    name: pyqt book
chapter:
    - python introduce
    - qt introduce
</code></pre>

<h2>reStructuredText</h2>

<h2>rst2s5</h2>

<h2>sphinx</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/development-experience/">开发经验</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-23T10:02:28+08:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2010</time>
        
         | <a href="/blog/development-experience/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这里面整理了一些零散的开发经验, 方便提醒自己, 以及给其他人灵感.</p>

<ul>
<li>写代码本质上来讲是把信息量体现在代码上面,
最好写下来的代码正好反应出项目的信息.
比如代码本质上是实现一个状态机, 那么就需要写清楚,
然人一看就知道是状态机(有向图)</li>
<li>要让代码复杂度反映在代码行数上面. no一行流</li>
<li>C语言是lisp的底层抽象?</li>
<li>C语言每个语句的性能是平衡的, 能够从C代码中看出程序性能消耗?</li>
<li>python函数边界不做类型检查, 运行时刻再去判断类型, 造成性能下降,
但是也带来足够强大的抽象能力?</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/words/">箴言</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-21T21:25:52+08:00" pubdate data-updated="true">Dec 21<span>st</span>, 2010</time>
        
         | <a href="/blog/words/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这里收集了一些我的语录, 以及我转述其他人的语录(会注明,
大多数不记得转述谁的了), 如果一股读者味道不要怪我.
如果我没有按照我说的话做也不要怪我. 我也只是一个心灵脆弱的人.</p>

<p>新的东西添加在前面:</p>

<ul>
<li>如果一个人活得和别人一样, 那么他给这个世界带来了什么信息量呢?</li>
<li>编程的快乐, 本质上是创造的快乐: 你以自己的方式完成了工作,
工作本身刻有你自己的烙印.</li>
<li>婚姻是一个合约, 任何超过十年的合约, 在这个时代都是带有巨大风险的.
但是什么时候我们能够有渐进的婚姻呢?</li>
<li>人活着需要的东西其实很少, 即使你在大城市里面, 即使你工资不多.</li>
<li>精神上的乐趣比物质上的乐趣更有持久性.</li>
<li>人工作的目标是需要工作的时间越来越少, 而不是越来越多. (转述)</li>
<li>人活着本身没有意义, 如果你产生了这样的问题,
那么期望的结果是不会再问这个问题了. (转述维特根斯坦)</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/why-use-plain-text/">为什么要用纯文本</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-21T21:25:52+08:00" pubdate data-updated="true">Dec 21<span>st</span>, 2010</time>
        
         | <a href="/blog/why-use-plain-text/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>什么是纯文本</h2>

<p>我们所说的纯文本, 有几层含义:</p>

<h2>任何信息, 都采用文本的方式来展示</h2>

<p>我们拒绝任何形式的二进制格式, 拒绝任何形式的私有格式, 我们只支持纯文本.</p>

<p>比如: Word, PPT, Excel, 他们都是只能用微软的工具打开的,
并且都是二进制的, 不能被文本编辑工具修改.</p>

<h2>文本的编码必须是统一的标准编码</h2>

<p>要么ASCII, 要么UTF-8, 拒绝任何其他的编码格式. 比如gbk等.</p>

<h2>文本本身的数据, 反映出文本需要展示的信息量</h2>

<p>比如:</p>

<pre><code>&lt;elementType id="Book" name="pyqt book"&gt;
    &lt;elementType id="chapter" title="python introduce"&gt; 
    &lt;/elementType&gt;
    &lt;elementType id="chapter" title="qt introduce"&gt; 
    &lt;/elementType&gt;
&lt;/elementType&gt;
</code></pre>

<p>虽然格式是纯文本的(xml), 但是不能很好地被人理解, 所以我们认为是坏的,
不符合纯文本的要义.</p>

<p>我们应该这样:</p>

<pre><code>Book:
    name: pyqt book
chapter:
    - python introduce
    - qt introduce
</code></pre>

<h2>一个示例</h2>

<p>本文就是采用纯文本方式编辑的, 原始文件可以在
<a href="https://bitbucket.org/linjunhalida/blog/src/tip/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E7%BA%AF%E6%96%87%E6%9C%AC.rst">这里</a>
看到.</p>

<h2>为什么要用纯文本</h2>

<p>我们为什么要使用纯文本?</p>

<ul>
<li><p>纯文本是方便人阅读和修改的 纯文本反映了本文所承载的信息,
我们阅读和修改都能够针对具体的信息, 而不像某些专有软件,
需要熟悉软件的特殊功能, 才能获取我们想要的信息.</p></li>
<li><p>纯文本是自由的, 不依赖任何第三方工具 如果你把纯文本发给其他人,
其他人可以直接获取到纯文本中的信息, 而不像二进制的文件,
必须要安装指定的软件. 如果该软件无法获取,
专有格式文件中的信息就遗失了.</p></li>
</ul>


<h2>注意点</h2>

<ul>
<li>我们不反对程序自动生成的文件(不需要人阅读的部分)是其他格式的.
我们只关心人有可能看的部分.
如果你用纯文本生成pdf等格式展示给其他人看,
我们不要求pdf本身是纯文本的.. 因为这只是个中间产物, 如果有需要,
我们直接去看源码, 而源码 <strong>必须</strong> 是纯文本的.</li>
</ul>


<h2>纯文本工具链</h2>

<p>为了能够实践我们纯文本主义, 我们需要有强大的工具作为支持:</p>

<ul>
<li><a href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> 这是我们的主要文档编写工具. 适合人编写和阅读, 也可以很容易地转变为其他需要的格式.</li>
<li><a href="http://s5project.org/">S5</a> 文本方式写幻灯片. S5本身是html的, 为了能够深刻实践纯文本主义, 我们建议你采用 <a href="http://docutils.sourceforge.net/docs/user/slide-shows.html">rst2s5</a>.</li>
<li><a href="http://www.graphviz.org/">graphviz</a> 文本方式画图. 文本方式编写图的结构和显示, 没有再适合的了.</li>
<li><a href="http://en.wikipedia.org/wiki/Comma-separated_values">csv</a> 表格. 单一的符号以及回车符分割开具体的数据, csv非常适合阅读和修改.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/sphinx-intro/">Sphinx介绍</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-19T19:17:22+08:00" pubdate data-updated="true">Dec 19<span>th</span>, 2010</time>
        
         | <a href="/blog/sphinx-intro/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>什么是sphinx?</h2>

<p><img src="http://www.crystalinks.com/sphinx.jpg" alt="image" /></p>

<h2>它有什么特性?</h2>

<ul>
<li>python文档所使用的系统</li>
<li>输出HTML, LaTeX, manual pages, 纯文本..</li>
<li>层级结构, 内链</li>
<li>自动索引</li>
<li>语法高亮</li>
<li>扩展: graphivz, docstrings, 等等..</li>
</ul>


<h2>让我们开始尝试一下</h2>

<p>安装
  ~ easy_install -U Sphinx</p>

<p>教程
  ~ <a href="http://sphinx.pocoo.org/tutorial.html">http://sphinx.pocoo.org/tutorial.html</a></p>

<h2>创建一个项目</h2>

<pre><code>sphinx-quickstart
</code></pre>

<h2>目录</h2>

<pre><code>$ find
.
./Makefile               # 工具帮我们生成的makefile
./build                  # 生成文档后放置的目录
./source                 # 文档源码的位置
./source/index.rst       # 文档的入口
./source/conf.py         # 项目的一些设置, 上面quickstart设置的部分内容可以在里面修改
./source/_static         # 静态文档存放目录
./source/_templates      # 模板存放目录
</code></pre>

<h2>开写哈</h2>

<pre><code>Contents:

.. toctree::
   :maxdepth: 2

# 我们在这里加内容
intro
tutorial
</code></pre>

<h2>文档对象</h2>

<pre><code>.. py:function:: enumerate(sequence[, start=0])

Return an iterator that yields tuples of an index and an item of the
*sequence*. (And so on.)

这里是连接 :py:func:`enumerate`
</code></pre>

<h2>自动导入代码中的文档</h2>

<pre><code>.. autofunction:: io.open

.. automodule:: io
   :members:
</code></pre>

<h2>生成我们需要的格式</h2>

<p>sphinx-build</p>

<pre><code>$ sphinx-build -b html sourcedir builddir
</code></pre>

<p>make</p>

<pre><code>$ make html
</code></pre>

<h2>资源</h2>

<p>官方文档 <a href="http://sphinx.pocoo.org">http://sphinx.pocoo.org</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/online-update/">程序如何作在线更新</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-17T11:01:49+08:00" pubdate data-updated="true">Dec 17<span>th</span>, 2010</time>
        
         | <a href="/blog/online-update/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>问题</h2>

<p><img src="http://lh4.ggpht.com/_os_zrveP8Ns/TQrJ7IXV-_I/AAAAAAAADOU/AFzkVbp1W_8/s800/101118-Caribou-web.jpg" alt="image" /></p>

<p>我们的客户端程序庞大, 笨重, 更为严重的是, 当我们的程序发布给用户之后,
如果没有问题还好, 遇到了bug, 修改很成问题.
如何把更新后的程序发布给用户呢? 很多项目在做架构的时候,
选择采用web方式来绕过这样的问题. 但是很多时候还是非用客户端程序不可.
如何让客户端程序实现在线更新功能? 这里提供我的一个非常简单的解决方案.</p>

<h2>思路</h2>

<p>更新的业务逻辑很简单. 只需要下面几步:</p>

<ul>
<li>去某个服务器, 下载一个记录有版本信息的文档.</li>
<li>与本地程序的版本号做比较, 如果不是最新的, 提示用户更新程序.</li>
<li>更新程序的方法: 去服务器下载一个压缩包, 解压覆盖本地程序.</li>
</ul>


<p>然后是具体实现上面的逻辑.</p>

<h2>要点</h2>

<ul>
<li><p>服务器必须能够被客户访问到.</p>

<p>如果是在外网的话, 必须有一个存放更新文件的公共服务器. 我采用 <a href="http://code.google.com">google
code</a> 存放文件. 一个项目上传文件的限额是2G,
足够用了. 你也可以选择自己搭建一个http/ftp服务器,
或者用dropbox(被墙掉了), everbox(现在还不支持共享文件).</p></li>
<li><p>更新程序. 下载程序后, 需要覆盖当前程序目录, windows下面,
开启后的程序会加锁执行文件, 所以需要运行另外的一个程序来做更新.
下面是具体的逻辑.</p></li>
</ul>


<h2>更新程序解决方案</h2>

<p>比如旧程序在dir_a目录下面, 可执行文件是a.exe.
星号括起来的是当前正在执行的文件.</p>

<pre><code>dir_a: **a.exe**
</code></pre>

<p>我们把dir_a拷贝出一份, 到dir_backup, 最新的程序保存到dir_backup里面,
保存为new.tar.gz. 下载完毕后, 我们在dir_b里面建立一个文件,
叫need_update, 作为标识.</p>

<pre><code>dir_a: **a.exe**
dir_backup: a.exe, new.tar.gz, need_update
</code></pre>

<p>用 <a href="http://docs.python.org/library/os.html#os.execl">execl</a>
(c/c++/python/都可以用类似的函数调用), 关闭当前程序,
跳到dir_backup环境里面, 执行dir_backup/a.exe.</p>

<pre><code>dir_a: a.exe
dir_backup: **a.exe**, new.tar.gz, need_update
</code></pre>

<p>dir_backup/a.exe启动的时候检查当前目录下面是否有need_update, 有的话,
就解压new.tar.gz, 覆盖dir_a. 这个时候程序已经更新完成了.</p>

<pre><code>dir_a: new.exe
dir_backup: **a.exe**, new.tar.gz, need_update
</code></pre>

<p>然后再用 `execl`, 放弃当前程序, 执行dir_a/new.exe.</p>

<pre><code>dir_a: **new.exe**
dir_backup: a.exe, new.tar.gz, need_update
</code></pre>

<p>步骤虽然有点复杂, 但是顶用, 也不需要另外加一个更新程序.
对于python发布出去的代码来说, 一个可执行文件就上M了, 少一个是一个.</p>

<p>下面是实际代码, 因为是从实际项目中挖出来的, 保证不能用.
都是update.py这一个源文件的:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span></span><span class="kn">from</span> <span class="nn">qtlib</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">qtlib.download</span> <span class="kn">import</span> <span class="n">download</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">add_config</span><span class="p">,</span> <span class="n">conf</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">tools.progresser</span> <span class="kn">import</span> <span class="n">Progresser</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">tarfile</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">distutils.dir_util</span> <span class="kn">import</span> <span class="n">copy_tree</span>
</span><span class='line'><span class="n">SERVER</span> <span class="o">=</span> <span class="s2">&quot;http://project.googlecode.com/files/&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;具体更新的方法&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;开始准备更新, 是否继续?&#39;</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 检查是否有更新</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_update</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 复制program</span>
</span><span class='line'>    <span class="n">temp_path</span> <span class="o">=</span> <span class="s1">&#39;../</span><span class="si">%s</span><span class="s1">.backup&#39;</span> <span class="o">%</span> <span class="n">program</span>
</span><span class='line'>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">program</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">temp_path</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 下载程序</span>
</span><span class='line'>    <span class="n">tar_file</span> <span class="o">=</span> <span class="n">program</span> <span class="o">+</span> <span class="s1">&#39;.tar.gz&#39;</span>
</span><span class='line'>    <span class="n">local_tar_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">tar_file</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">with</span> <span class="n">Progresser</span><span class="p">(</span><span class="s2">&quot;下载中, 比较忙, 你可以离开位置休息一下..&quot;</span><span class="p">,</span><span class="s2">&quot;退出&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">download</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">+</span> <span class="n">tar_file</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">local_tar_file</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">stepper</span> <span class="o">=</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
</span><span class='line'>            <span class="n">showMsg</span><span class="p">(</span><span class="s2">&quot;无法连接到服务器, 请检查是否连上外部网络!&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="n">showMsg</span><span class="p">(</span><span class="s1">&#39;取消下载, 不好意思, 下次还得从头开始下载..&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">showMsg</span><span class="p">(</span><span class="s1">&#39;下载完成, 现在安装新程序.&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># 解压</span>
</span><span class='line'>    <span class="n">unzip</span><span class="p">(</span><span class="n">tar_file</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># 标示一下是新程序</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;need_update&#39;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># 执行新程序</span>
</span><span class='line'>    <span class="n">program_name</span> <span class="o">=</span> <span class="n">program</span><span class="o">+</span><span class="s1">&#39;.exe&#39;</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">execl</span><span class="p">(</span><span class="n">program_name</span><span class="p">,</span> <span class="n">program_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">check_update</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;检查是否有更新&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="c1"># 下载versions文件</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">download</span><span class="p">(</span><span class="n">SERVER</span><span class="o">+</span><span class="s1">&#39;versions&#39;</span><span class="p">,</span> <span class="s1">&#39;temp/versions&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
</span><span class='line'>        <span class="n">showMsg</span><span class="p">(</span><span class="s2">&quot;无法连接到服务器, 请检查是否连上外部网络!&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">False</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 读取里面的信息</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;temp/versions&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>    <span class="c1"># 格式是: program + 空格 + 版本号</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">program</span><span class="p">):</span>
</span><span class='line'>            <span class="n">new_version</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>            <span class="c1"># 把版本号当作浮点来检查</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_version</span><span class="p">):</span>
</span><span class='line'>                <span class="k">return</span> <span class="bp">True</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="n">showMsg</span><span class="p">(</span><span class="s2">&quot;程序已经是最新版本: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">check_finish_update</span><span class="p">():</span>
</span><span class='line'>    <span class="c1"># 检查当前是否是需要更新的临时文件</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;need_update&#39;</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>    <span class="c1"># 读取程序名称</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;need_update&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>        <span class="n">program</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;need_update&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># 然后把新程序复制回去</span>
</span><span class='line'>    <span class="n">old_path</span> <span class="o">=</span> <span class="s1">&#39;../</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">program</span>
</span><span class='line'>    <span class="n">copy_tree</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">old_path</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># 执行程序</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
</span><span class='line'>    <span class="n">program_name</span> <span class="o">=</span> <span class="n">program</span> <span class="o">+</span> <span class="s1">&#39;.exe&#39;</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">execl</span><span class="p">(</span><span class="n">program_name</span><span class="p">,</span> <span class="n">program_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 加载update.py模块的时候, 判断当前是否为在backup过程中执行的..</span>
</span><span class='line'><span class="n">check_finish_update</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>其他</h2>

<p>基于上面的更新逻辑, 我们还可以根据需求, 补充一些功能:</p>

<ul>
<li>启动的时候检查更新. 只需要用threading.Thread(target=check_update,
&hellip;)来用一个线程跑更新检查就可以了.</li>
<li>后台更新. 也可以用一个线程跑下载, 下载完毕后, 再通知主线程.</li>
<li>增量更新, 减少下载时间. 可以考虑用diff之类工具.</li>
</ul>


<p>如果有人觉得这样的更新脚本有价值的话, 可以联系我,
让我整理出一份不依赖其他模块的代码出来.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/27/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/25/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/radio-useless/">收音机没啥用了</a>
      </li>
    
      <li class="post">
        <a href="/blog/ipkvm/">低成本IPKVM控制多台主机</a>
      </li>
    
      <li class="post">
        <a href="/blog/bed-car/">床车方案</a>
      </li>
    
      <li class="post">
        <a href="/blog/car-air-conditioner/">床车空调方案</a>
      </li>
    
      <li class="post">
        <a href="/blog/work-in-car/">车作为第二空间</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/halida">@halida</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'halida',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2024 - 机械唯物主义 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'halidasvps';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
